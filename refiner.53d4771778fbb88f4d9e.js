!function(){var e,t,n={2929:function(e,t,n){"use strict";var r,i=n(655),o=n(7093),s=n.n(o);!function(e){e.PEG_HOLE="PEG_HOLE",e.FRAME="FRAME"}(r||(r={}));const a={topN:3,minArea:100,minExtent:.75,minVertexCount:4,adaptive:!1,useOtsu:!1};new class extends class{constructor(){this.ready=new Promise((e=>{s().onRuntimeInitialized=()=>{e(null)}})),this.debug=!1,this.configs=null,this.handleMessage()}onRequestPivot(e,t,n){return(0,i.mG)(this,void 0,void 0,(function*(){return new(s().Point)(0,0)}))}onRequestProcessing(e,t){return(0,i.mG)(this,void 0,void 0,(function*(){return e.clone()}))}createImageMat(e){const{width:t,height:n,buffer:r}=e,i=new(s().Mat)(n,t,s().CV_8UC4);return i.data.set(new Uint8ClampedArray(r)),i}pong(e){return(0,i.mG)(this,void 0,void 0,(function*(){yield this.ready,this.respond(e)}))}requestPivot(e){return(0,i.mG)(this,void 0,void 0,(function*(){const{mode:t,image:n,ROI:r}=e.data.body,i=this.createImageMat(n),o=new(s().Rect)(r.x,r.y,r.width,r.height);try{const n=yield this.onRequestPivot(t,i,o);this.respond(e,{result:{pivot:n}})}catch(t){this.handleError(e,t)}finally{i.delete()}}))}requestProcessing(e){return(0,i.mG)(this,void 0,void 0,(function*(){const t=this.createImageMat(e.data.body.image);try{const n=yield this.onRequestProcessing(t,e.data.body.filename),{buffer:r}=new Uint8ClampedArray(n.data);this.respond(e,{result:{image:{buffer:r,width:n.cols,height:n.rows}},transfer:[r]}),n.delete()}catch(t){this.handleError(e,t)}finally{t.delete()}}))}setConfigs(e){const{mode:t,fitFrame:n,refImage:r,ROI:i,pivot:o}=e.data.body.configs;this.configs={mode:t,fitFrame:n,refImage:this.createImageMat(r),pivot:new(s().Point)(o.x,o.y),ROI:new(s().Rect)(i.x,i.y,i.width,i.height)},this.respond(e)}setDebugMode(e){this.debug=e.data.body.debug}clean(e){var t;null===(t=this.configs)||void 0===t||t.refImage.delete(),this.configs=null,this.respond(e)}checkConfig(){if(!this.configs)throw new Error("[worker] configs not set")}respond(e,{result:t,error:n,transfer:r}={}){self.postMessage({respondTo:e.data.request,id:e.data.id,error:n,result:t},r||[])}handleError(e,t){console.error("[worker]",t),this.respond(e,{error:t.message})}handleMessage(){self.addEventListener("message",(e=>(0,i.mG)(this,void 0,void 0,(function*(){var t;switch(null===(t=e.data)||void 0===t?void 0:t.request){case"ping":yield this.pong(e);break;case"set-debug":this.setDebugMode(e);break;case"set-configs":this.setConfigs(e);break;case"clean":this.clean(e);break;case"request-pivot":yield this.requestPivot(e);break;case"request-processing":yield this.requestProcessing(e);break;default:console.warn("[worker] unknown message",e)}}))))}}{constructor(){super(...arguments),this.baseSize=null}findPolygons(e,t,{minArea:n,minExtent:r,minVertexCount:i,topN:o,adaptive:a,useOtsu:c}){const l=e.roi(t),u=new(s().Mat);if(s().cvtColor(l,u,s().COLOR_RGBA2GRAY,0),a)s().adaptiveThreshold(u,u,255,s().ADAPTIVE_THRESH_GAUSSIAN_C,s().THRESH_BINARY_INV,31,2);else{let e=s().THRESH_BINARY_INV;c&&(e|=s().THRESH_OTSU),s().threshold(u,u,100,255,e)}const d=c?t.width*t.height*.9:1/0,f=new(s().MatVector),h=new(s().Mat);s().findContours(u,f,h,s().RETR_LIST,s().CHAIN_APPROX_SIMPLE);const g=[];for(let e=0;e<f.size();++e){const o=f.get(e),a=s().contourArea(o),c=s().arcLength(o,!0),u=new(s().Mat);if(s().approxPolyDP(o,u,.02*c,!0),u.rows>=i&&a>n&&a<d&&s().isContourConvex(u)){const n=s().minAreaRect(u),{width:i,height:o}=n.size,c=a/(i*o);if(c<r)continue;if(g.push({area:a,extent:c,rectSize:new(s().Size)(Math.max(i,o),Math.min(i,o)),center:new(s().Point)(t.x+n.center.x,t.y+n.center.y),angle:i<o?n.angle+90:n.angle}),this.debug){s().drawContours(l,f,e,new(s().Scalar)(255,0,0,255),3);const t=s().rotatedRectPoints(n);for(let e=0;e<4;e++)s().line(l,t[e],t[(e+1)%4],new(s().Scalar)(0,0,255,255),3,s().LINE_AA,0)}}o.delete(),u.delete()}f.delete(),h.delete(),u.delete(),l.delete(),function(e,t=10){let n=e.length;for(let r=0;r<n;r++){const i=e[r];for(let o=r+1;o<n;o++){const r=e[o];Math.abs(i.center.x-r.center.x)<t&&Math.abs(i.center.y-r.center.y)<t&&(e.splice(o,1),o--,n--)}}}(g),g.sort(((e,t)=>t.area-e.area));const p=g.slice(0,o);return p.sort(((e,t)=>e.center.x-t.center.x)),p}findPolygonsWithTries(e,t,n=a){const r=Object.assign(Object.assign(Object.assign({},a),n),{adaptive:!1}),i=this.findPolygons(e,t,r);if(i.length===r.topN)return i;this.debug&&console.log("%c[worker] non-adaptive threshold failed, trying adaptive...","color: #f60");const o=this.findPolygons(e,t,Object.assign(Object.assign({},r),{adaptive:!0}));if(o.length===r.topN)return o;throw new Error("対象を検出できませんでした")}pegHoleRotation(e,t){const n=this.findPolygonsWithTries(e,t,{useOtsu:!0,minVertexCount:5}),{center:r}=n[0],{center:i}=n[1],{center:o}=n[2],a=new(s().Point)((r.x+i.x+o.x)/3,(r.y+i.y+o.y)/3);return this.debug&&n.forEach((({center:t})=>{s().circle(e,t,10,new(s().Scalar)(255,0,0,255),-1)})),{center:a,angle:180*Math.atan2(o.y-r.y,o.x-r.x)/Math.PI,rectSize:n[0].rectSize}}frameRotation(e,t){const n=e.cols*e.rows,r=this.findPolygonsWithTries(e,t,{topN:1,minArea:.5*n,minExtent:0,minVertexCount:4})[0];return this.debug&&s().circle(e,r.center,10,new(s().Scalar)(255,0,0,255),-1),{center:r.center,angle:r.angle,rectSize:r.rectSize}}calcRotation(e,t,n){return e===r.PEG_HOLE?this.pegHoleRotation(t,n):this.frameRotation(t,n)}getRotationMatrix(e,t,n,r,i,o){const a=[1,0,e.x,0,1,e.y,0,0,1],c=[1,0,n,0,1,r,0,0,1],l=-t*Math.PI/180,u=Math.cos(l),d=Math.sin(l),f=[a,c,[u,-d,0,d,u,0,0,0,1],[i,0,0,0,o,0,0,0,1],[1,0,-e.x,0,1,-e.y,0,0,1]].reduce(((e,t)=>function(e,t){const n=[];for(let r=0;r<2;r++)for(let i=0;i<3;i++){let o=0;for(let n=0;n<3;n++)o+=e[3*r+n]*t[3*n+i];n[3*r+i]=o}return n.push(0,0,1),n}(e,t)));return s().matFromArray(2,3,s().CV_64FC1,f.slice(0,6))}setConfigs(e){super.setConfigs(e);const{mode:t,refImage:n,ROI:i}=this.configs;if(t===r.FRAME){const{rectSize:e}=this.calcRotation(t,n,i);this.baseSize=e}}clean(e){super.clean(e),this.baseSize=null}onRequestPivot(e,t,n){return(0,i.mG)(this,void 0,void 0,(function*(){const{center:r}=this.calcRotation(e,t,n);return r}))}onRequestProcessing(e,t){return(0,i.mG)(this,void 0,void 0,(function*(){const{mode:n,refImage:i,ROI:o,pivot:a}=this.configs,c=new(s().Size)(i.cols%2==0?i.cols:i.cols+1,i.rows%2==0?i.rows:i.rows+1),l=new(s().Mat);s().resize(e,l,c);const{center:u,angle:d,rectSize:f}=this.calcRotation(n,l,o),h=a.x-u.x,g=a.y-u.y;let p=1,m=1;n===r.FRAME&&this.configs.fitFrame&&(p=this.baseSize.width/f.width,m=this.baseSize.height/f.height),this.debug&&console.log([`filename: ${t}`,`tx: ${h}`,`ty: ${g}`,`sx: ${p}`,`sy: ${m}`,`angle: ${d}`].join("\n"));const v=this.getRotationMatrix(u,d,h,g,p,m),y=new(s().Mat);return s().warpAffine(l,y,v,c,s().INTER_CUBIC,s().BORDER_CONSTANT,new(s().Scalar)(255,255,255,255)),v.delete(),l.delete(),y}))}}},3499:function(){},2999:function(){},8300:function(){}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var o=r[e]={id:e,exports:{}};return n[e].call(o.exports,o,o.exports,i),o.exports}i.m=n,i.x=function(){var e=i.O(void 0,[216,977],(function(){return i(2929)}));return i.O(e)},e=[],i.O=function(t,n,r,o){if(!n){var s=1/0;for(u=0;u<e.length;u++){n=e[u][0],r=e[u][1],o=e[u][2];for(var a=!0,c=0;c<n.length;c++)(!1&o||s>=o)&&Object.keys(i.O).every((function(e){return i.O[e](n[c])}))?n.splice(c--,1):(a=!1,o<s&&(s=o));if(a){e.splice(u--,1);var l=r();void 0!==l&&(t=l)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[n,r,o]},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.f={},i.e=function(e){return Promise.all(Object.keys(i.f).reduce((function(t,n){return i.f[n](e,t),t}),[]))},i.u=function(e){return{216:"vendors",977:"opencv"}[e]+"."+{216:"2a42100c994558b3f97c",977:"a1d009f617e5a1f5d520"}[e]+".js"},i.miniCssF=function(e){},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.j=696,function(){var e;i.g.importScripts&&(e=i.g.location+"");var t=i.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e}(),function(){var e={696:1};i.f.i=function(t,n){e[t]||importScripts(i.p+i.u(t))};var t=self.webpackChunkkeyframe_refiner=self.webpackChunkkeyframe_refiner||[],n=t.push.bind(t);t.push=function(t){var r=t[0],o=t[1],s=t[2];for(var a in o)i.o(o,a)&&(i.m[a]=o[a]);for(s&&s(i);r.length;)e[r.pop()]=1;n(t)}}(),t=i.x,i.x=function(){return Promise.all([i.e(216),i.e(977)]).then(t)},i.x()}();