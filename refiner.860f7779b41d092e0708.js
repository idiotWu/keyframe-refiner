!function(){var e,t,n={2929:function(e,t,n){"use strict";var r,o=n(655),i=n(7093),s=n.n(i);!function(e){e.PEG_HOLE="PEG_HOLE",e.FRAME="FRAME"}(r||(r={})),new class extends class{constructor(){this.ready=new Promise((e=>{s().onRuntimeInitialized=()=>{e(null)}})),this.debug=!1,this.configs=null,this.handleMessage()}onRequestPivot(e,t,n){return(0,o.mG)(this,void 0,void 0,(function*(){return new(s().Point)(0,0)}))}onRequestProcessing(e,t,n,r,i){return(0,o.mG)(this,void 0,void 0,(function*(){return t.clone()}))}createImageMat(e){const{width:t,height:n,buffer:r}=e,o=new(s().Mat)(n,t,s().CV_8UC4);return o.data.set(new Uint8ClampedArray(r)),o}pong(e){return(0,o.mG)(this,void 0,void 0,(function*(){yield this.ready,this.respond(e)}))}requestPivot(e){return(0,o.mG)(this,void 0,void 0,(function*(){const{mode:t,image:n,ROI:r}=e.data.body,o=this.createImageMat(n),i=new(s().Rect)(r.x,r.y,r.width,r.height);try{const n=yield this.onRequestPivot(t,o,i);this.respond(e,{result:{pivot:n}})}catch(t){this.handleError(e,t)}finally{o.delete()}}))}requestProcessing(e){return(0,o.mG)(this,void 0,void 0,(function*(){const{mode:t,refImage:n,ROI:r,pivot:o}=this.configs,i=this.createImageMat(e.data.body.image);try{const s=yield this.onRequestProcessing(t,i,n,r,o),{buffer:a}=new Uint8ClampedArray(s.data);this.respond(e,{result:{image:{buffer:a,width:s.cols,height:s.rows}},transfer:[a]}),s.delete()}catch(t){this.handleError(e,t)}finally{i.delete()}}))}setConfigs(e){const{mode:t,refImage:n,ROI:r,pivot:o}=e.data.body.configs;this.configs={mode:t,refImage:this.createImageMat(n),pivot:new(s().Point)(o.x,o.y),ROI:new(s().Rect)(r.x,r.y,r.width,r.height)},this.respond(e)}setDebugMode(e){this.debug=e.data.body.debug}clean(e){var t;null===(t=this.configs)||void 0===t||t.refImage.delete(),this.configs=null,this.respond(e)}checkConfig(){if(!this.configs)throw new Error("[worker] configs not set")}respond(e,{result:t,error:n,transfer:r}={}){self.postMessage({respondTo:e.data.request,id:e.data.id,error:n,result:t},r||[])}handleError(e,t){console.error("[worker]",t),this.respond(e,{error:t.message})}handleMessage(){self.addEventListener("message",(e=>(0,o.mG)(this,void 0,void 0,(function*(){var t;switch(null===(t=e.data)||void 0===t?void 0:t.request){case"ping":yield this.pong(e);break;case"set-debug":this.setDebugMode(e);break;case"set-configs":this.setConfigs(e);break;case"clean":this.clean(e);break;case"request-pivot":yield this.requestPivot(e);break;case"request-processing":yield this.requestProcessing(e);break;default:console.warn("[worker] unknown message",e)}}))))}}{findPolygons(e,t,n=100,r=.75,o=3){const i=e.roi(t),a=new(s().Mat);s().medianBlur(i,a,5),s().cvtColor(i,a,s().COLOR_RGBA2GRAY,0),s().threshold(a,a,100,255,s().THRESH_BINARY_INV);const c=new(s().MatVector),u=new(s().Mat);s().findContours(a,c,u,s().RETR_LIST,s().CHAIN_APPROX_SIMPLE);const d=[];for(let e=0;e<c.size();++e){const o=c.get(e),a=s().contourArea(o),u=s().arcLength(o,!0),l=new(s().Mat);if(s().approxPolyDP(o,l,.02*u,!0),l.rows>=4&&a>n&&s().isContourConvex(l)){const n=s().minAreaRect(l),{width:o,height:u}=n.size,f=a/(o*u);if(f<r)continue;if(d.push({area:a,extent:f,center:new(s().Point)(t.x+n.center.x,t.y+n.center.y),angle:o<u?n.angle+90:n.angle}),this.debug){s().drawContours(i,c,e,new(s().Scalar)(255,0,0,255),3);const t=s().rotatedRectPoints(n);for(let e=0;e<4;e++)s().line(i,t[e],t[(e+1)%4],new(s().Scalar)(0,0,255,255),3,s().LINE_AA,0)}}o.delete(),l.delete()}c.delete(),u.delete(),a.delete(),i.delete(),d.sort(((e,t)=>t.area-e.area));const l=d.slice(0,o);return l.sort(((e,t)=>e.center.x-t.center.x)),l}pegHoleRotation(e,t){const n=this.findPolygons(e,t);if(n.length<3)throw new Error("タップ穴を検出できませんでした");const{center:r}=n[0],{center:o}=n[1],i=new(s().Point)(o.x,o.y);return this.debug&&n.forEach((({center:t})=>{s().circle(e,t,10,new(s().Scalar)(255,0,0,255),-1)})),{center:i,angle:180*Math.atan2(o.y-r.y,o.x-r.x)/Math.PI}}frameRotation(e,t){const n=e.cols*e.rows,r=this.findPolygons(e,t,.5*n,0,1)[0];if(!r)throw new Error("フレームを検出できませんでした");return this.debug&&s().circle(e,r.center,10,new(s().Scalar)(255,0,0,255),-1),{center:r.center,angle:r.angle}}calcRotation(e,t,n){return e===r.PEG_HOLE?this.pegHoleRotation(t,n):this.frameRotation(t,n)}onRequestPivot(e,t,n){return(0,o.mG)(this,void 0,void 0,(function*(){const{center:r}=this.calcRotation(e,t,n);return r}))}onRequestProcessing(e,t,n,r,i){return(0,o.mG)(this,void 0,void 0,(function*(){const o=new(s().Size)(n.cols,n.rows),a=new(s().Mat);s().copyMakeBorder(t,a,0,Math.max(0,o.height-t.rows),0,Math.max(0,o.width-t.cols),s().BORDER_CONSTANT,new(s().Scalar)(255,255,255,255));const{center:c,angle:u}=this.calcRotation(e,a,r),d=s().getRotationMatrix2D(c,u,1);d.data64F[2]+=i.x-c.x,d.data64F[5]+=i.y-c.y;const l=new(s().Mat);return s().warpAffine(a,l,d,o,s().INTER_LINEAR,s().BORDER_CONSTANT,new(s().Scalar)(255,255,255,255)),d.delete(),a.delete(),l}))}}},3499:function(){},2999:function(){},8300:function(){}},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={id:e,exports:{}};return n[e].call(i.exports,i,i.exports,o),i.exports}o.m=n,o.x=function(){var e=o.O(void 0,[216,977],(function(){return o(2929)}));return o.O(e)},e=[],o.O=function(t,n,r,i){if(!n){var s=1/0;for(d=0;d<e.length;d++){n=e[d][0],r=e[d][1],i=e[d][2];for(var a=!0,c=0;c<n.length;c++)(!1&i||s>=i)&&Object.keys(o.O).every((function(e){return o.O[e](n[c])}))?n.splice(c--,1):(a=!1,i<s&&(s=i));if(a){e.splice(d--,1);var u=r();void 0!==u&&(t=u)}}return t}i=i||0;for(var d=e.length;d>0&&e[d-1][2]>i;d--)e[d]=e[d-1];e[d]=[n,r,i]},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,{a:t}),t},o.d=function(e,t){for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.f={},o.e=function(e){return Promise.all(Object.keys(o.f).reduce((function(t,n){return o.f[n](e,t),t}),[]))},o.u=function(e){return{216:"vendors",977:"opencv"}[e]+"."+{216:"4e5b31aa0c83debf4632",977:"a1d009f617e5a1f5d520"}[e]+".js"},o.miniCssF=function(e){},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.j=696,function(){var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e}(),function(){var e={696:1};o.f.i=function(t,n){e[t]||importScripts(o.p+o.u(t))};var t=self.webpackChunkkeyframe_refiner=self.webpackChunkkeyframe_refiner||[],n=t.push.bind(t);t.push=function(t){var r=t[0],i=t[1],s=t[2];for(var a in i)o.o(i,a)&&(o.m[a]=i[a]);for(s&&s(o);r.length;)e[r.pop()]=1;n(t)}}(),t=o.x,o.x=function(){return Promise.all([o.e(216),o.e(977)]).then(t)},o.x()}();